name: Release

on:
  push:
    branches: [master]

jobs:
  test:
    name: Test
    strategy:
      matrix:
        platform: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Install Go
        uses: actions/setup-go@v2
        with:
          go-version: ^1.16
        id: go
      - name: Check out code into the Go module directory
        uses: actions/checkout@v2
      - name: Get dependencies
        run: |
          go get -v -t -d ./...
      - name: Run tests
        run: go test ./... -coverprofile profile.cov
      - name: Send coverage
        uses: shogo82148/actions-goveralls@v1
        with:
          path-to-profile: profile.cov
          flag-name: ${{ matrix.platform }}-go-${{ matrix.go-version }}
          parallel: true

  finish:
    name: Finish
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - name: Sending coverage finished
        uses: shogo82148/actions-goveralls@v1
        with:
          parallel-finished: true

  build:
    name: Build
    strategy:
      matrix:
        os: [linux, darwin]
        arch: [amd64, arm64]
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - name: Set up Go 1.x
        uses: actions/setup-go@v2
        with:
          go-version: ^1.16
        id: go
      - name: Check out code into the Go module directory
        uses: actions/checkout@v2
      - name: Get dependencies
        run: |
          go get -v -t -d ./...
      - name: Get build timestamp
        run: echo "::set-output name=timestamp::$(date -u '+%Y-%m-%d_%I:%M:%S%p')"
      - name: Build
        run: GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} go build -ldflags -X "github.com/sinhashubham95/go-actuator/core.BuildStamp=${{ steps.date.outputs.timestamp }}" -X "github.com/sinhashubham95/go-actuator/core.GitCommitID=$GITHUB_SHA" -X "github.com/sinhashubham95/go-actuator/core.GitPrimaryBranch=$GITHUB_REF" -X "github.com/sinhashubham95/go-actuator/core.GitURL=$GITHUB_SERVER_URL/$GITHUB_REPOSITORY" -X "github.com/sinhashubham95/go-actuator/core.Username=sinhashubham95" -X "github.com/sinhashubham95/go-actuator/core.HostName=sinhashubham95"  -X "github.com/sinhashubham95/go-actuator/core.GitCommitTime=${{ steps.date.outputs.timestamp }}" -X "github.com/sinhashubham95/go-actuator/core.GitCommitAuthor=sinhashubham95" -v
      - name: Rename build
        run: |
          mv moxy moxy-${{ matrix.os }}-${{ matrix.arch }}
      - name: Upload Build
        uses: skx/github-action-publish-binaries@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: 'moxy-*'